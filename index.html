<!DOCTYPE html>
<html lang="jp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <meta name="robots" content="noindex">
    <link rel="stylesheet" href="./css/styles.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js" crossorigin></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        (() => {
            const question  = [
                // { id: 0, numbers: [1,3,4,5], operand: 0, isDone: false, isCorrected: false },
                // { id: 1, numbers: [4,5,2,3], operand: 0, isDone: false, isCorrected: false  },
                // { id: 2, numbers: [6,8,9,7], operand: 0, isDone: false, isCorrected: false  },
            ]
            window.onload = () => {
                let focus = document.getElementById('c-1');
                focus.focus();
            };
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            function DoneList(props) {
                const doneList = props.doneList.map((val, i) => {
                    return (
                        <li
                            key={i}
                            id={'donelist-'.concat(i)}>
                            {val.num[0] * 10 + val.num[1]}×{val.num[2] * 10 + val.num[3]}
                            <span>  {val.isCorrected?"true":"false"}</span>
                            <span>  {val.timer}</span>
                        </li>
                    );
                });
                return (
                    <ol >
                        {doneList}
                    </ol>
                );
            }
            function CalculatorContainer(props) {
                return (
                    <div>
                        <div id="calculatorContainer" className="culculator-container">
                            <input type="text" placeholder="0" readOnly value={props.curQuestion.num[0]} />
                            <input type="text" placeholder="0" readOnly value={props.curQuestion.num[1]} />
                            <input type="text" value="✕" readOnly />
                            <input type="text" placeholder="0" readOnly value={props.curQuestion.num[2]} />
                            <input type="text" placeholder="0" readOnly value={props.curQuestion.num[3]} />
                        </div>
                    </div>
                );
            }
            function CreateContainer(props) {
                return (
                    <div className="create-container">
                        <input id="c-1" type="text" readOnly placeholder="0" value={props.localInput.num[0]} />
                        <input id="c-2" type="text" readOnly placeholder="0" value={props.localInput.num[1]} />
                        <select defaultValue={props.localInput.operand}>
                            <option value="0">✕</option>
                            <option value="1">＋</option>
                            <option value="2">÷</option>
                            <option value="3">－</option>
                        </select>
                        <input id="c-3" type="text" readOnly placeholder="0" value={props.localInput.num[2]} />
                        <input id="c-4" type="text" readOnly placeholder="0" value={props.localInput.num[3]} />
                    </div>
                );
            }
            function AnswerContainer(props) {
                let str = ''.concat(props.localInput.num[0]).concat(props.localInput.num[1]).concat(props.localInput.num[2]).concat(props.localInput.num[3]);
                str = str.substring(0, props.localInput.pos);
                return (
                    <div className="answer-wrapper">
                        <div className="answer-container">
                            ANSWER:<input id="answer" type="text" placeholder="0" readOnly value={str} />
                        </div>
                        <div id="timerContainer" className="timer-container">
                            {props.timer}
                        </div>
                    </div>
                );
            }
            function ArithmeticContainer(props) {
                return (
                    <div className="arithmetic-container">
                        <CalculatorContainer curQuestion={props.curQuestion} />
                        { props.opentab === tabvalue[0]
                            ? <CreateContainer localInput={props.localInput} /> 
                            : <AnswerContainer 
                                localInput={props.localInput}
                                timer={props.timer} /> }
                    </div>
                );
            }
            function OpentabContainer(props) {
                const tabarray = tabvalue.map((val, i) => {
                    return (
                        <div
                            key={i}
                            id={'tabcontainer-'.concat(val)}>
                            <input 
                                type="radio" 
                                name="opentab"
                                id={'opentab-'.concat(val)}
                                checked={props.opentab === val}
                                onChange={(e) => props.changeTab(val)} />
                            <label
                                className="tab-item"
                                htmlFor={'opentab-'.concat(val)}>
                                {val}
                            </label>
                        </div>
                    );
                });
                return (
                    <div className="opentab-container">
                        {tabarray}
                    </div>
                );
            }
            function NumberButton(props) {
                const btns = [...Array(10)].map((_, i) => i).map((val, key) => {
                    return (
                        <input
                            key={key}
                            className="numBtn"
                            type="button"
                            id={"num-".concat(val)}
                            value={val}
                            onClick={(e) => {props.inputNumBtn(e.target.value)}} />
                    );
                });
                return (
                    <div className="number-button">
                        {btns}
                    </div>
                );
            }
            function StatusButton(props) {
                return (
                    <div className="status-button">
                        <input type="button" className="stateBtn" value="＜" />
                        <input type="button" className="stateBtn" value="＞" />
                        <input type="button" className="stateBtn" onClick={(e) => {props.clickEnterBtn(e)}} value="Enter" />
                        <input type="button" className="stateBtn" value="1char Clear" />
                        <input type="button" className="stateBtn" onClick={(e) => {props.clickAllClearBtn(e)}}value="All Clear" />
                    </div>
                );
            }
            function SideBarBtn(props) {
                return (
                    <span className="sidebar-btn" onClick={(e) => {props.clickSideBtn(e)}}>{props.doneList.length}</span>
                );
            }
            function InputContainer(props) {
                return (
                    <div className="input-container">
                        <NumberButton
                            localInput={props.localInput}
                            inputNumBtn={props.inputNumBtn}
                        />
                        <StatusButton
                            localInput={props.localInput}
                            clickEnterBtn={props.clickEnterBtn}
                            clickAllClearBtn={props.clickAllClearBtn}
                        />
                    </div>
                );
            }
            const timeover = 60;
            const tabvalue = ['create', 'answer'];
            const default_question = {
                            num: [ 0, 0, 0, 0],
                            operand: 0,
                            isDone: false,
                            isCorrected: false,
                            correct: null,
                            timer: 0,
                        };
            const default_local = {
                            num: [ 0, 0, 0, 0 ],
                            pos: 0,
                            operand: 0
                        };
            let startTime = null;
            let timerFunction = null;
            function copyObjects(target) {
                return Object.assign({}, JSON.parse(JSON.stringify(target)));
            }
            class App extends React.Component {
                constructor() {
                    super();
                    this.state = {
                        opentab: tabvalue[0],
                        localInput: copyObjects(default_local),
                        previousIsCorrected: false,
                        curQuestion: copyObjects(default_question),
                        done: [],
                        timer: 0,
                    }
                    this.changeTab = this.changeTab.bind(this);
                    this.inputNumBtn = this.inputNumBtn.bind(this);
                    this.clickEnterBtn = this.clickEnterBtn.bind(this);
                    this.clickAllClearBtn = this.clickAllClearBtn.bind(this);
                    this.timerStart = this.timerStart.bind(this);
                    // this.timerPause = this.timerPause.bind(this);
                    this.timerClear = this.timerClear.bind(this);
                    this.clickSideBtn = this.clickSideBtn.bind(this);
                    this.execNextQuestion = this.execNextQuestion.bind(this);
                }
                timerStart() {
                    timerFunction = setTimeout(() => {
                        if (this.state.timer > (timeover - 1 )) {
                            this.setState({
                                timer: "time over"
                            });
                            clearTimeout(timerFunction);
                            timerFunction = null;
                            this.execNextQuestion(false);
                            //this.changeTab('create');
                            return;
                        } 
                        this.setState({
                            timer: Math.abs(Math.ceil((startTime - Date.now()) / 1000))
                        });
                        this.timerStart();
                    }, 1000);
                }

                timerClear() {
                    this.setState({
                        timer: 0
                    });
                    if (timerFunction != null) {
                        clearTimeout(timerFunction);
                        timerFunction = null;
                    } 
                }
                clickAllClearBtn(e){
                    this.setState({
                        localInput: {
                            num: [0,0,0,0],
                            pos: 0,
                        },
                    })
                } 
                clickSideBtn(e) {
                    const sidebar = e.target.parentElement;
                    if (sidebar.classList.contains('open')) {
                        sidebar.classList.remove('open');
                    } else {
                        sidebar.classList.add('open');
                    }
                }
                execNextQuestion = (flg = true) => {
                    
                    let posIndex = this.state.localInput.pos;
                    let judge = flg === false ? false : this.state.curQuestion.correct === parseInt(this.state.localInput.num.join('').substring(0, posIndex));
                    let arr = this.state.done;
                    let curQuestion = this.state.curQuestion;
                    curQuestion.isDone = true;
                    curQuestion.isCorrected = judge;
                    curQuestion.timer = flg === false ? timeover : this.state.timer;
                    arr.push(curQuestion);
                    this.setState({
                        previousIsCorrecte: judge,
                        curQuestion: copyObjects(default_question),
                        localInput: copyObjects(default_local),
                        done: arr,
                    });
                    let calculatorContainer = document.getElementById('calculatorContainer');
                    calculatorContainer.classList.add('answer-checked');
                    calculatorContainer.classList.add(judge);
                    this.changeTab('create');
                    setTimeout(() => {
                        calculatorContainer.classList.remove('answer-checked');
                        calculatorContainer.classList.remove(judge);
                        clearTimeout(this);
                    }, 2000);
                }
                clickEnterBtn(e){
                    if (this.state.opentab === tabvalue[0]) {
                        if (this.state.localInput.pos !== 4) {
                            return;
                        }
                        let num = Array.from(this.state.localInput.num);
                        let correct = (num[0] * 10 + num[1] ) * (num[2] * 10 + num[3] );
                        // console.log("corect:" + correct);
                        let curQuestion = {
                            num: this.state.localInput.num,
                            operand: this.state.localInput.operand,
                            isDone: false,
                            isCorrected: false,
                            correct: correct,
                            timer: 0,
                        }
                        this.setState({
                            curQuestion: curQuestion,
                            localInput: copyObjects(default_local)
                        });
                        // console.log(curQuestion);
                        this.changeTab('answer');
                    } else if (this.state.opentab === tabvalue[1]) {
                        this.execNextQuestion();
                    }
                }
                inputNumBtn(val){
                    let arr = Array.from(this.state.localInput.num);
                    arr[this.state.localInput.pos] = parseInt(val);
                    let newpos = this.state.localInput.pos + 1;
                    this.setState({
                        localInput: {
                            num: arr,
                            pos: newpos
                        }
                    });
                    // console.log([this.state.localInput.pos, this.state.localInput.num]);
                }
                changeTab(tabvalueString) {
                    this.setState({
                        opentab : (tabvalue.filter((val) => { return val === tabvalueString })).toString(),
                    });
                    if (tabvalueString===tabvalue[1]){
                        startTime = Date.now();
                        this.timerStart();
                    } else {
                        this.timerClear();
                    }
                }
                render() {
                    return (
                        <div className="wrapper">
                            <div className="container">
                                <ArithmeticContainer
                                    opentab={this.state.opentab}
                                    localInput={this.state.localInput}
                                    curQuestion={this.state.curQuestion}
                                    timer={this.state.timer} />
                                <OpentabContainer
                                    opentab={this.state.opentab}
                                    changeTab={this.changeTab} />
                                <InputContainer
                                    opentab={this.state.opentab}
                                    localInput={this.state.localInput}
                                    inputNumBtn={this.inputNumBtn}
                                    clickEnterBtn={this.clickEnterBtn} 
                                    clickAllClearBtn={this.clickAllClearBtn} />
                            </div>
                            <div className="sidebar">
                                <SideBarBtn 
                                    clickSideBtn={this.clickSideBtn}
                                    doneList={this.state.done}
                                     />
                                <DoneList 
                                    doneList={this.state.done}
                                />
                            </div>
                        </div>
                    );
                };
            }
             
            root.render(<App />);
        })();
    </script>
</body>
</html>